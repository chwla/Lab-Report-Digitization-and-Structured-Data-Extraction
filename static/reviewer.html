<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Report Reviewer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #343a40; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: #495057; }
        input, select { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: left; word-wrap: break-word; }
        th { background-color: #f8f9fa; }
        td input { width: 100%; }
        .low-confidence { background-color: #fff3cd; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        .remove-btn { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .actions-cell { width: 60px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>Lab Report Reviewer üî¨</h1>
    
    <div class="form-group">
        <label for="reportSelector">Select a Report to Review:</label>
        <select id="reportSelector" onchange="loadReport()"></select>
    </div>

    <div id="report-content" style="display: none;">
        <h2 id="currentReportTitle"></h2>
        <form id="reviewForm">
            <h3>Patient & Report Details</h3>
            <div id="patient-fields" class="form-grid"></div>

            <h3>Test Results</h3>
            <table id="results-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Test Name</th>
                        <th style="width: 15%;">Value</th>
                        <th style="width: 20%;">Unit</th>
                        <th>Reference Range</th>
                        <th class="actions-cell">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <br>
            <button type="button" onclick="saveCorrections()">Save Confirmed Data</button>
        </form>
    </div>
</div>

<script>
    const API_BASE_URL = "/api";
    const CONFIDENCE_THRESHOLD = 90;

    async function populateReportSelector() { /* ... unchanged ... */ }

    async function loadReport() {
        const selector = document.getElementById('reportSelector');
        const reportName = selector.value;
        const reportContentDiv = document.getElementById('report-content');

        if (!reportName) {
            reportContentDiv.style.display = 'none';
            return;
        }

        document.getElementById('currentReportTitle').textContent = `Reviewing: ${reportName}`;

        try {
            const response = await fetch(`${API_BASE_URL}/report/${reportName}`);
            const data = await response.json();
            
            // Populate patient fields
            const fieldsContainer = document.getElementById('patient-fields');
            fieldsContainer.innerHTML = '';
            for (const [key, valueObj] of Object.entries(data.fields || {})) {
                const isLowConf = (valueObj.confidence || 100) < CONFIDENCE_THRESHOLD;
                fieldsContainer.innerHTML += `
                    <div class="form-group">
                        <label for="field-${key}">${key}</label>
                        <input type="text" id="field-${key}" name="${key}" value="${valueObj.value || ''}" class="${isLowConf ? 'low-confidence' : ''}">
                    </div>
                `;
            }

            // Populate test results table
            const tableBody = document.querySelector('#results-table tbody');
            tableBody.innerHTML = '';
            (data.test_results || []).forEach((result, index) => {
                const isLowConf = (result.confidence || 100) < CONFIDENCE_THRESHOLD;
                const row = tableBody.insertRow();
                row.className = isLowConf ? 'low-confidence' : '';
                row.innerHTML = `
                    <td><input type="text" value="${result.test_name || ''}" data-key="test_name"></td>
                    <td><input type="text" value="${result.value || ''}" data-key="value"></td>
                    <td><input type="text" value="${result.unit || ''}" data-key="unit"></td>
                    <td><input type="text" value="${result.reference_range || ''}" data-key="reference_range"></td>
                    <td class="actions-cell"><button type="button" class="remove-btn" onclick="removeRow(this)">üóëÔ∏è</button></td>
                `;
            });

            reportContentDiv.style.display = 'block';
        } catch (error) { console.error("Error loading report data:", error); }
    }

    function removeRow(button) {
        // Find the table row (tr) that contains the button and remove it
        button.closest('tr').remove();
    }

    async function saveCorrections() { /* ... unchanged ... */ }

    window.onload = populateReportSelector;

    // --- Unchanged Functions (for brevity) ---
    async function populateReportSelector() {
        try {
            const response = await fetch(`${API_BASE_URL}/reports`);
            const data = await response.json();
            const selector = document.getElementById('reportSelector');
            selector.innerHTML = '<option value="">-- Please select a report --</option>';
            data.reports.forEach(report => {
                selector.add(new Option(report, report));
            });
        } catch (error) { console.error("Error fetching report list:", error); }
    }
    
    async function saveCorrections() {
        const reportName = document.getElementById('reportSelector').value;
        if (!reportName) return;

        const correctedData = { fields: {}, test_results: [] };

        document.querySelectorAll('#patient-fields input').forEach(input => {
            correctedData.fields[input.name] = { value: input.value, confidence: 100.0 };
        });

        document.querySelectorAll('#results-table tbody tr').forEach(row => {
            const result = { confidence: 100.0 };
            row.querySelectorAll('input').forEach(input => {
                result[input.dataset.key] = input.value;
            });
            correctedData.test_results.push(result);
        });

        try {
            const response = await fetch(`${API_BASE_URL}/save/${reportName}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(correctedData)
            });
            const result = await response.json();
            alert(result.message);
        } catch (error) { console.error("Error saving corrections:", error); }
    }
</script>
</body>
</html>